<!DOCTYPE html> 
<html lang="jp"> 	
<head> 		
	<meta charset="utf-8"> 		
	<meta　http-equiv="X-UA-Compatible" content="IE=edge"> 		
	<meta name="viewport" content="width=device-width, initial-scale=1"> 		
	<title>ポケミク てすと</title> 		
	<link href="css/bootstrap.min.css" rel="stylesheet"> 		
	<script src="js/nsx39.js"></script> 		
	<script src="js/flatKeyboard.js"></script>
	<script src="js/jquery-1.11.0.min.js"></script>

	<script type="text/javascript">
	var midiAccess = null;
	var output = null;

	function onMIDIMessage(event) {
		console.log("Receive midi" + event);
		if (output) {
			if ((event.data[0]=='0x80') || ((event.data[0]=='0x90')&&(event.data[2]=='0x00'))) {
					//if (((event.data[0]=='0x90')&&(event.data[2]!='0x00'))) {
						sendNoteandChar(event.data, window.performance.now());
					} else {
						output.send(event.data, window.performance.now());
					}
				}
			}

			function listInputsAndOutputs(access) {
				var inputs = midiAccess.inputs();
				var outputs = midiAccess.outputs();

				console.log("inputs:" + inputs.length + " " + "outputs:" + outputs.length);
				for ( i = 0; i < inputs.length; i++) {
					console.log("Input port #" + i + ": type:'" + inputs[i].type + "' id:'" + inputs[i].id + "' manufacturer:'" + inputs[i].manufacturer + "' name:'" + inputs[i].name + "' version:'" + inputs[i].version + "'");
					var option = document.createElement("option");

					option.setAttribute("value", "midiInput");
					option.appendChild(document.createTextNode(inputs[i].name));
					document.getElementById("midiInputSelect").appendChild(option);
				}

				for ( i = 0; i < outputs.length; i++) {
					console.log("Output port #" + i + ": type:'" + outputs[i].type + "' id:'" + outputs[i].id + "' manufacturer:'" + outputs[i].manufacturer + "' name:'" + outputs[i].name + "' version:'" + outputs[i].version + "'");
					var option = document.createElement("option");
					option.setAttribute("value", "midiOuput");
					option.appendChild(document.createTextNode(outputs[i].name));
					document.getElementById("midiOutputSelect").appendChild(option);
				}
			}

			function onMIDISuccess(access) {
				midiAccess = access;
				console.log("midi ready!");
				listInputsAndOutputs(access);
			}

			function onMIDIFailure(msg) {
				console.log("Failed to midi available- " + msg);
			}

			function selectMidiInput() {
				var select = document.getElementById("midiInputSelect");
				var options = document.getElementById("midiInputSelect").options;
				var value = options.item(select.selectedIndex).value;
				console.log("midi input selected: " + select.selectedIndex);
				try {
					var inputs = midiAccess.inputs();
					var input = inputs[select.selectedIndex - 1];
					input.onmidimessage = onMIDIMessage;
				} catch (e) {
					console.error("Exception! Couldn't get i/o ports." + e);
				}
			}

			function selectMidiOutput() {
				var select = document.getElementById("midiOutputSelect");
				var options = document.getElementById("midiOutputSelect").options;
				var value = options.item(select.selectedIndex).value;
				console.log("midi output selected: " + select.selectedIndex);
				try {
					var outputs = midiAccess.outputs();
					output = outputs[select.selectedIndex - 1];
				} catch (e) {
					console.error("Exception! Couldn't get i/o ports." + e);
				}
			}

			var lyrics = [];
			var curIndex;
			var curChar = [];
			var curStr = "";

			function onClickConvert() {
				var srcText = $("#inputLyrics").val();
				var url = "http://aikelab.net/mikugo/api.cgi?" +
				"chouon=Y&hiragana=Y&sentence="+encodeURIComponent(srcText)+
				"&type=jsonp&callback=?";
				$.getJSON(url,function(data) {
					console.log("done");
					$("#inputLyrics").val(data.result);
				});
			}

			function onClickOK() {
				if (!output) {
					alert("MIDI Outを指定してください");
					return;
				}
				lyrics = [];
				curIndex = 0;
				curChar = [];
				var srcText = document.getElementById("inputLyrics").value;
				lyrics = srcText.concat();
				sendChar(window.performance.now());
				updateLyrics();
			}

			function updateLyrics() {
				var dispLyrics1 = [];
				var currentChar = [];
				var dispLyrics2 = [];
				var lastCharlength = 0;
				for ( i = 0; i < lyrics.length; i++) dispLyrics1[i] = lyrics[i];
				if (curIndex < lyrics.length) {
					currentChar = dispLyrics1.splice(curIndex - curChar.length);
					dispLyrics2 = currentChar.splice(curChar.length);
					lastCharlength = curChar.length;
				} else {
					currentChar = dispLyrics1.splice(lyrics.length-lastCharlength-1);
					dispLyrics2 = "";					
				}
				var dispArea = document.getElementById("lyricArea");
				dispArea.innerHTML = "<font color=brack></font>"
				for ( i = 0; i < dispLyrics1.length; i++)
					dispArea.innerHTML += dispLyrics1[i];
				dispArea.innerHTML += "<font color=red><b>" + curStr + "</b></font>"
				dispArea.innerHTML += "<font color=brack></font>"
				for ( i = 0; i < dispLyrics2.length; i++)
					dispArea.innerHTML += dispLyrics2[i];
			}

			function sendNoteandChar(noteMsg, timestamp) {
				if (curIndex < lyrics.length) {
					sendChar(timestamp);
					updateLyrics();
				}
				output.send(noteMsg, timestamp);
			}

			function sendChar(timestamp) {
				while (curIndex < lyrics.length) {
					curChar = [];
					curChar[0] = lyrics[curIndex++];
					if (curIndex<lyrics.length) {
						if (lyrics[curIndex].match(/ぁ|ぃ|ぅ|ぇ|ぉ|ゃ|ゅ|ょ|っ/) != null) {
							curChar[1] = lyrics[curIndex++];
						}
					}
					curStr = "";
					for (i=0;i<curChar.length;i++) curStr += curChar[i];
						var msg = nsx39.getSysEx(curStr);
					if (msg && output) {
						output.send(msg, timestamp);
						break;
					}
				}
			}

			function showMidiMsg(msg) {
				var str = [];
				for ( i = 0; i < msg.length; i++) {
					str += "0x" + msg[i].toString(16) + " ";
				}
				console.log(str);
			}
			</script>
		</head>
		<body>
			<div class="container" style="padding:20px 0">
				<p>
					<div class="container">
						<div class="page-header" >
							<h2>ポケミクてすと</h2>
							<div>
								あらかじめ入力しておいた文字列をNoteOnが来るたびに一文字ずつ出力します。<br>
								MIDI InにNSX39を指定するとポケットミクのスタイラスで演奏することもできます(もちろん普通のMIDIキーボードでも可)<br>
								ブラウザはGoogle Chromeを使ってください。<br>
								WebMIDIAPIを使うためにGoogle Chromeを設定する必要があります。詳しくは<a href="http://otonanokagaku.net/nsx39/app.html">ポケットミクアプリのページ</a>を参考にしてください。<br>
								なお、flatkeyはryoyakawaiさんの<a href="https://github.com/ryoyakawai/WebMIDIAPIWrapper">Web MIDI API Wrapper</a>を使用しています。<br>
								ミク語変換はaikeさんの<a hrer="http://aikelab.net/mikugo/">ミク語変換</a>を使わせていただきました。
							</div>
						</div>
					</div>
				</p>
				<label class="control-label">MIDI In</label>
				<select id="midiInputSelect" class="form-control" onchange="selectMidiInput()">
					<option value="1">select input port</option>
				</select>
				<label class="control-label">MIDI Out</label>
				<select id="midiOutputSelect" class="form-control" onchange="selectMidiOutput()">
					<option value="1">select output port</option>
				</select>

				<div class="container">
					<form class="form-horizontal">
						<span >歌詞入力</span>
						<div class="form-group">
							<div class="col-md-4">
								<textarea id="inputLyrics" class="form-control" rows="10"></textarea>
							</div>
						</div>
					</form>
					<button class="btn btn-primary" onclick="onClickConvert()">
						ミク語変換
					</button>
					<button class="btn btn-primary" onclick="onClickOK()">
						決定
					</button>
				<!-- option 固定で chouon:ON,hiragana:ONあとはデフォルトで
				<DIV id="check">
				<INPUT name="opt_conv_chouon" TYPE="checkbox" value="true"> 長音を直前の母音に変換する<BR>
				<INPUT name="opt_sep_bunsetsu" TYPE="checkbox" value="true"> 文節ごとに区切る<BR>
				<INPUT name="opt_hiragana" TYPE="checkbox" value="true"> すべてひらがなに変換<BR>
				<INPUT name="opt_romaji" TYPE="checkbox" value="true"> convert to Romaji<BR>
				<INPUT name="opt_bilingual" TYPE="checkbox" value="true"> bilingual
				</DIV>
			-->
			<hr>
			<p>
				<div id="lyricArea">
					<!-- 歌詞表示エリア -->
				</div>
			</p>
			<hr>
		</div>
		<div class="container" style="width: 640px; margin:20px 0px 0px 55px;">
			<div class="keyCanvasArea">
				<canvas id="keyboard" height="0px"></canvas>
			</div>
		</div>

	</div>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>

	<script type="text/javascript">
	var fKey = new FlatKeyboard("keyboard");
	var timerId = setInterval(function() {
		fKey.draw();
	}, 80);
	fKey.setConnected();
	fKey.noteOn = function(noteNo) {
		output.send([0x90, noteNo, 0x7f]);
				//sendNoteandChar([0x90, noteNo, 0x00]);
			};
			fKey.noteOff = function(noteNo) {
				var now = window.performance.now();
				sendNoteandChar([0x80, noteNo, 0x00], now + 200);
				//output.send([0x80, noteNo, 0x40], now + 200);
			};
			</script>
			<script  type="text/javascript">
			midiAccess = navigator.requestMIDIAccess({
				sysex : true
			}).then(onMIDISuccess, onMIDIFailure);
			</script>
		</body>
		</html>
